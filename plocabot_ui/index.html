<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="dynamic-title">Cargando...</title>
    <link rel="icon" href="" id="dynamic-icon">
    <link rel="stylesheet" href="index.css" class="web_icon_chatbot">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
  </head>
  
  <body>
    <div class="mainContainer">
      <div class="userProfile">
        <h1 id="nameInitial">A</h1>
      </div>
      <div id="userMenu" class="user-menu" style="display: none;">
        <button id="theme-btn"><i class="fa-solid fa-circle-half-stroke"></i> Tema</button>
        <div id="theme-dropdown" class="dropdown-menu hidden">
          <ul>
            <li id="dark"><a href="#" data-theme="dark"><i class="fa-solid fa-moon"></i> Oscuro</a></li>
            <li id="light"><a href="#" data-theme="light"><i class="fa-regular fa-sun"></i> Claro</a></li>
          </ul>
        </div>

        <button id="voice-btn"><i class="fa-solid fa-wave-square"></i> Voz</button>
        <div id="voice-dropdown" class="dropdown-menu hidden">
          <ul>
            <li id="pablo"><a href="#" data-voice="pablo"><i class="fa-solid fa-person"></i> Pablo</a></li>
            <li id="laura"><a href="#" data-voice="laura"><i class="fa-solid fa-person-dress"></i> Laura</a></li>
          </ul>
        </div>

        <div class="relative">
          <button id="language-btn" class="bg-white text-gray-700 px-3 py-1 rounded-lg shadow transition duration-300 hover:bg-gray-100">
            <i class="fa-solid fa-language"></i> Idioma
          </button>
          <div id="language-dropdown" class="dropdown-menu hidden">
            <ul>
              <li><a href="#">Español</a></li>
              <li><a href="#">English</a></li>
              <li><a href="#">Français</a></li>
            </ul>
          </div>
        </div>
        <hr>
        <button onclick="logOut()" id="logOut"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
      </div>
      
      <div class="historialContainer" id="historialContainer">
        <div class="topHistorial">
          <a id="urlEmpresa"><img src="" id="logoEmpresa" class="logoHistorial"></a>
        </div>
        
        <div class="itemsHistorial">
          <div class="historial-header">
            <div class="historialNames">
              <h1>Historial</h1>
              <i class="fa-duotone fa-solid fa-magnifying-glass" id="searchicon"></i>
            </div>
            <div class="textHistorialContainer">
              <p class="textHistorial nuevaConversacionItem" id="newChatMain" onclick="newConversation()">
                <i class="fa-duotone fa-solid fa-pen-to-square" id="newChat"></i> Nueva conversación
              </p>
            </div>
          </div>
        </div>

        <!-- HISTORIAL REAL -->
        <div class="mainCenterHistorial" id="historial-list">
          <!-- Aquí se inyectará el historial desde JS -->
        </div>

        <div class="closeHistorialContainer">
          <i class="fa-solid fa-arrow-left" id="closeHistorial" onclick="closeHistorial()"></i>
        </div>
      </div>

      <div class="openHistorialContainer">
        <i class="fa-solid fa-arrow-right" id="openHistorial" onclick="openHistorial()"></i>
      </div>
      
      <div class="chat-container">
        <header>
          <img src="" id="textoBot" class="chatbot_name">
        </header>
        <main id="chat">
          <!-- Mensajes del chat -->
        </main>

        <main id="conversationOptions" style="display: none;" class="new-main-screen">
          <div class="mainConversation">
            <dotlottie-player src="https://lottie.host/05b6f4c9-ceb4-47f8-9aa8-1ed1cd016d7a/wzQmOvKlBR.lottie" background="transparent" speed="1" style="width: 400px; height: 400px" loop autoplay></dotlottie-player>
          </div>
          <div class="options-container">
            <button id="openMic" style="display: none;"><i class="fa-solid fa-microphone"></i></button>
            <button id="muteMic"><i class="fa-solid fa-microphone-slash"></i></button>
            <button id="exitBtn"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </main>

        <form id="chat-form">
          <input type="text" id="user-input" placeholder="Escribe tu mensaje aquí..." autocomplete="off">
          <button type="submit" id="enviar">Enviar</button>
        </form>
        <div class="buttonsExtra">
          <button id="conversationBtn" type="button"><i class="material-icons">graphic_eq</i></button>
          <button id="startBtn" type="button"><i class="fa-solid fa-microphone"></i></button>
          <button id="stopBtn" type="button" class="hidden"><i class="fa-solid fa-stop"></i></button>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script>
      window.onload = () => {
        document.title = CONFIG.botName + " - " + CONFIG.companyName;
        document.getElementById("dynamic-icon").href = CONFIG.iconPath;
        document.getElementById("logoEmpresa").src = CONFIG.logoPath;
        document.getElementById("urlEmpresa").href = CONFIG.urlPath;
        document.getElementById("textoBot").src = CONFIG.botTextImage;
        document.body.style.backgroundRepeat = "no-repeat";
        document.body.style.backgroundSize = "cover";
        document.body.style.backgroundPosition = "center";
      };

      document.getElementById("conversationBtn").addEventListener("click", async (event) => {
        // Ocultar vista anterior
        document.getElementById('historialContainer').style.display = 'none';
        document.getElementById("chat").style.display = "none";
        document.getElementById("chat-form").style.display = "none";
        document.querySelector(".buttonsExtra").style.display = "none";

        // Mostrar vista nueva
        document.getElementById("conversationOptions").style.display = "flex";
        document.getElementById("conversationOptions").style.backgroundColor = "#B3B3B3";

        // Iniciar grabación automática
        localStorage.setItem("voiceMode", true);
        try {
          await voice_recording(event);
        } catch (err) {
          logErrorPersistently(err);
          console.error("Error en voice_recording:", err);
        }
      });

      document.getElementById("muteMic").addEventListener("click", async (event) => {
        document.getElementById("muteMic").style.display = "none";
        document.getElementById("openMic").style.display = "block";
        
        try {
          await voice_stop_recording(event);
        } catch (err) {
          logErrorPersistently(err);
          console.error("Error en voice_recording:", err);
        }
      });

      document.getElementById("openMic").addEventListener("click", async (event) => {
        document.getElementById("openMic").style.display = "none";
        document.getElementById("muteMic").style.display = "block";

        try {
          await voice_recording(event);
        } catch (err) {
          logErrorPersistently(err);
          console.error("Error en voice_recording:", err);
        }
      });

      document.getElementById("exitBtn").addEventListener("click", async (event) => {
        // Mostrar vista anterior
        document.getElementById('historialContainer').style.display = 'flex';
        document.getElementById("chat").style.display = "block";
        document.getElementById("chat-form").style.display = "flex";
        document.querySelector(".buttonsExtra").style.display = "flex";
        document.getElementById("conversationOptions").style.display = "none";
        document.getElementById("openMic").style.display = "none";
        document.getElementById("muteMic").style.display = "block";

        localStorage.setItem("voiceMode", false);

        // Detener grabación
        isRecording = false;
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }

        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      });
    </script>
    <script src="index.js"></script>
  </body>
</html>
